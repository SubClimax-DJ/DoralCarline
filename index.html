<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doral Academy Car-Line</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Gruvbox Dark Colors */
        :root {
            --bg: #282828;
            --bg-dark: #1d2021;
            --bg-light: #3c3836;
            --bg-med: #504945;
            --fg: #ebdbb2;
            --fg-gray: #a89984;
            --red: #fb4934;
            --green: #b8bb26;
            --yellow: #fabd2f;
            --blue: #83a598;
            --purple: #d3869b;
            --aqua: #8ec07c;
            --orange: #fe8019;
            --border-color: #504945;
        }

        /* Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--fg);
            margin: 0;
            padding: 0;
            /* No padding-top, broadcast banner is removed */
        }
        .container {
            margin: 0 auto;
            padding: 0.75rem 1rem;
        }
        
        /* Header */
        header {
            background-color: var(--bg-dark);
            color: var(--fg);
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0; 
            z-index: 10;
        }
        .header-content {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 1.5rem; 
            margin: 0 auto;
        }
        .header-tabs {
            display: flex;
            gap: 0.5rem;
            background-color: var(--bg-med);
            border-radius: 8px;
            padding: 4px;
        }
        .tab-btn {
            background-color: transparent;
            border: none;
            color: var(--fg-gray);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active, .tab-btn:hover {
            background-color: var(--bg-light);
            color: var(--fg);
        }

        #auth-status {
            font-size: 0.9rem;
            color: var(--fg-gray);
            margin-left: auto; /* Changed from 1rem to auto to push to right */
        }
        .connected { color: var(--green) !important; }
        .disconnected { color: var(--red) !important; }

        /* Sections */
        .section {
            background-color: var(--bg-light);
            border: none;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--aqua);
            margin-top: 0;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        h3 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--blue);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        
        /* Forms */
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--fg);
            font-size: 1rem;
            box-sizing: border-box; 
            margin-bottom: 0.5rem;
            font-family: 'Inter', sans-serif;
        }
        textarea {
            min-height: 100px;
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 2px var(--blue);
        }
        .btn {
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .btn-blue { background-color: var(--blue); color: var(--bg-dark); }
        .btn-green { background-color: var(--green); color: var(--bg-dark); }
        .btn-gray { background-color: var(--bg-med); color: var(--fg); }
        .btn-red { background-color: var(--red); color: var(--fg); }
        .btn-purple { background-color: var(--purple); color: var(--bg-dark); }
        .btn-orange { background-color: var(--orange); color: var(--bg-dark); }
        
        .btn-group { display: flex; gap: 0.5rem; }
        .btn-group .btn { flex: 1; }
        .btn-full { width: 100%; }

        .flag-icon {
            font-size: 1.1rem;
            margin-left: 4px;
            vertical-align: middle;
        }


        /* Search Results */
        #search-results, #sibling-group-list {
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 0.25rem;
        }
        #sibling-group-list { min-height: 50px; }
        .search-item, .sibling-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
        }
        .search-item:hover {
            background-color: var(--bg-light);
        }
        .search-item.group-result {
            background-color: var(--bg-dark);
            border-left: 3px solid var(--green);
        }
        .sibling-item {
            background-color: var(--bg-dark);
            margin: 0.25rem;
        }
        .search-item-actions { display: flex; gap: 4px; }
        .search-item-actions .btn { padding: 4px 6px; font-size: 0.75rem; }
        
        /* Tables */
        .table-container {
            max-height: 65vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            text-align: left;
            font-size: 0.9rem;
        }
        th {
            background-color: var(--bg-light);
            font-weight: 600;
            color: var(--aqua);
            position: sticky; /* Sticky header for table */
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #32302f;
        }
        tr.highlighted, .highlighted {
            background-color: var(--yellow) !important;
            color: var(--bg-dark) !important;
            font-weight: 600;
        }
        tr.highlighted code, .highlighted code {
            color: var(--bg-dark);
        }
        td.actions-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .action-btn {
            padding: 6px; /* Increased padding */
            border-radius: 4px;
            color: var(--bg-dark);
            font-size: 0.75rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn svg {
            width: 14px;
            height: 14px;
        }
        .btn-delete { background-color: var(--red); color: var(--fg); }
        .btn-highlight { background-color: var(--yellow); }
        .btn-note { background-color: var(--blue); }
        .btn-re-add { background-color: var(--aqua); color: var(--bg-dark); }

        /* Sibling Group List in Table */
        .sibling-group-ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .sibling-group-ul li {
            padding: 4px;
            margin: 2px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sibling-group-ul li.highlighted {
            background-color: var(--yellow);
            color: var(--bg-dark);
        }
        .sibling-group-ul li .actions-cell {
            padding-left: 8px;
            flex-shrink: 0; /* Prevent buttons from wrapping */
        }
        
        /* Modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 20;
            display: none; /* hidden */
            align-items: center;
            justify-content: center;
        }
        .modal-box {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
        }
        .modal-box h3 {
            color: var(--fg);
            margin-top: 0;
        }
        #modal-note-error {
            color: var(--red);
            font-size: 0.9rem;
            display: none; /* hidden */
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Toast / Snackbar Notifications */
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        #toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 300px;
        }
        .toast {
            padding: 1rem;
            border-radius: 6px;
            font-weight: 500;
            color: var(--bg-dark);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards;
        }
        .toast.success {
            background-color: var(--green);
        }
        .toast.error {
            background-color: var(--red);
            color: var(--fg); /* Red has better contrast with light text */
        }


        /* --- Phone Mode (Always On) --- */
        
        /* Simplify Header */
        body.phone-mode .header-content {
            gap: 0.5rem; /* Tighten spacing */
        }
        body.phone-mode #auth-status {
            display: none; /* Hide status */
        }
        body.phone-mode .header-tabs {
            flex: 1; /* Let tabs fill space */
        }
        
        /* Hide "Picked Up" list */
        body.phone-mode #queues-view > .section:nth-of-type(3) {
            display: none;
        }
        
        /* Stack Grids */
        body.phone-mode .grid-3 {
            grid-template-columns: 1fr;
        }
        
        /* Improve Tappability & Sizing */
        body.phone-mode .btn {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            font-weight: 600;
        }
        body.phone-mode input[type="text"],
        body.phone-mode input[type="password"],
        body.phone-mode textarea {
            font-size: 1.1rem;
            padding: 0.8rem;
        }
        body.phone-mode .search-item-actions .btn {
            padding: 0.5rem 0.8rem;
            font-size: 0.9rem;
        }

        /* Enlarge Tables */
        body.phone-mode .table-container {
            max-height: 50vh; /* Allow a bit more scroll */
        }
        body.phone-mode th, 
        body.phone-mode td {
            padding: 10px 12px;
            font-size: 1rem; /* Larger text */
        }
        body.phone-mode .action-btn {
            padding: 10px;
        }
        body.phone-mode .action-btn svg {
            width: 20px;
            height: 20px;
        }
        body.phone-mode .sibling-group-ul li {
            font-size: 1rem;
        }

        /* Enlarge Modals */
        body.phone-mode .modal-box {
            max-width: 95%;
            padding: 1rem;
        }
        body.phone-mode .modal-actions {
            margin-top: 1.5rem;
        }

        /* Fix for Phone Mode Search Bar */
        body.phone-mode #search-results {
            max-height: 30vh; 
        }
        body.phone-mode .search-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem; 
            padding: 0.75rem; 
        }
        body.phone-mode .search-item-actions {
            flex-direction: column;
            width: 100%;
            gap: 0.5rem; 
        }
        body.phone-mode .search-item-actions .btn {
            width: 100%;
            padding: 0.75rem 1rem; 
            font-size: 1rem;
        }
        
        /* --- NEW: Classroom View (copied from index.html) --- */
        #classroom-view .section {
            min-height: 85vh;
        }
        #classroom-list-container {
            /* Use CSS columns for a dense list */
            column-count: 5; /* Start with 5, can be adjusted */
            column-gap: 1.5rem;
            background-color: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            min-height: 75vh; /* Ensure it fills space */
        }
        .classroom-list-item {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--fg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 4px;
            /* Prevent item from breaking across columns */
            break-inside: avoid-column;
        }
        .classroom-list-item.highlighted {
            background-color: var(--yellow);
            color: var(--bg-dark);
            font-weight: 600;
        }
        .classroom-list-item span.grade {
            color: var(--fg-gray);
            font-size: 0.9rem;
            margin-left: 4px;
        }
        .classroom-list-item.highlighted span.grade {
            color: var(--bg-dark);
        }
        
        /* Responsive columns for classroom view (copied from index.html) */
        @media (max-width: 1200px) {
            #classroom-list-container { column-count: 4; }
        }
        @media (max-width: 900px) {
            #classroom-list-container { column-count: 3; }
        }
        
        /* Phone Mode: Stack classroom view into 2 columns (copied from index.html) */
        body.phone-mode #classroom-list-container {
            column-count: 2;
        }
        body.phone-mode .classroom-list-item {
            font-size: 1.2rem;
        }
        /* NOTE: We are NOT hiding the classroom-tab-btn in phone-only view */

        /* --- End Phone Mode --- */
    </style>
</head>
<body class="phone-mode"> <!-- Phone mode is hardcoded -->
    
    <!-- HEADER -->
    <header>
        <div class="header-content">
            <!-- Tabs -->
            <div class="header-tabs">
                <button id="queues-tab-btn" class="tab-btn active">Queues</button>
                <!-- NEW: Classroom Tab Button -->
                <button id="classroom-tab-btn" class="tab-btn">Classroom View</button>
            </div>
            <div id="auth-status">Connecting...</div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container">
    
        <!-- 1. QUEUES VIEW -->
        <div id="queues-view">
            <!-- 1. Add Student to Queue -->
            <section class="section">
                <h2>1. Add Student to Queue</h2>
                <div class="grid-3">
                    <!-- Column 1: Search -->
                    <div>
                        <h3>Find Student</h3>
                        <input type="text" id="search-input" placeholder="Type a student's name...">
                        <div id="search-results">
                            <p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Start typing to see results...</p>
                        </div>
                    </div>
                    
                    <!-- Column 2: Manual Add -->
                    <div>
                        <h3>Manual Add</h3>
                        <input type="text" id="manual-name-input" placeholder="Manual name (e.g., 'Visitor')">
                        <div class="btn-group">
                            <button id="manual-add-btn" class="btn btn-blue" data-queue="1">Pre-K-5</button>
                            <button id="manual-add-btn-sib" class="btn btn-green" data-queue="2">6th-8th</button>
                            <button id="manual-add-btn-walk" class="btn btn-gray" data-queue="3">Walk</button>
                        </div>
                    </div>

                    <!-- Column 3: Group Add -->
                    <div>
                        <h3>Group Add</h3>
                        <p style="font-size: 0.9rem; color: var(--fg-gray); margin-bottom: 0.5rem;">Click "Group" in search to build a group below.</p>
                        <div id="sibling-group-list">
                            <p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students staged.</p>
                        </div>
                        <button id="add-staged-group-btn" class="btn btn-green btn-full" style="margin-top: 1rem;">
                            Add Group to Sibling Queue
                        </button>
                    </div>
                </div>
            </section>

            <!-- 2. Live Queues -->
            <section class="section">
                <h2>Live Queues</h2>
                <div class="grid-3">
                    <!-- K-5 Queue -->
                    <div>
                        <h3 style="color: var(--blue);">Pre-K thru Grade 5 <span id="q1-count">(0)</span></h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name (Grade)</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="q1-table-body">
                                    <tr><td colspan="3" style="text-align: center; color: var(--fg-gray);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Siblings Queue -->
                    <div>
                        <h3 style="color: var(--green);">Siblings & 6th - 8th <span id="q2-count">(0)</span></h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Students</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="q2-table-body">
                                    <tr><td colspan="2" style="text-align: center; color: var(--fg-gray);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Walkers Queue -->
                    <div>
                        <h3 style="color: var(--fg-gray);">Walkers <span id="q3-count">(0)</span></h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name (Grade)</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="q3-table-body">
                                    <tr><td colspan="3" style="text-align: center; color: var(--fg-gray);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 3. Picked Up List (Hidden by phone-mode CSS) -->
            <section class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="color: var(--purple); margin: 0; border: none; padding: 0;">Picked Up <span id="pickedup-count">(0)</span></h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Grade</th>
                                <th>Picked Up At</th>
                                <th>Wait Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pickedup-table-body">
                            <tr><td colspan="5" style="text-align: center; color: var(--fg-gray);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div> <!-- END of #queues-view -->
        
        <!-- 3. CLASSROOM VIEW (NEW) -->
        <div id="classroom-view" style="display: none;">
            <section class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="color: var(--yellow); margin: 0; border: none; padding: 0;">Student Pickup Queue (All Students)</h2>
                    <span id="classroom-total-count" style="font-size: 1.5rem; font-weight: 700; color: var(--fg);">(0)</span>
                </div>
                <div id="classroom-list-container">
                    <p style="text-align: center; color: var(--fg-gray); font-size: 1.2rem; padding: 2rem 0;">Loading students...</p>
                </div>
            </section>
        </div>

        <!-- Admin and Classroom views are REMOVED -->

    </main>
    
    <!-- MODALS -->

    <!-- Password Modal (REMOVED) -->
    
    <!-- Confirmation Modal (Kept for queue actions) -->
    <div id="confirmation-modal-backdrop" class="modal-backdrop">
        <div id="confirmation-modal-box" class="modal-box">
            <h3 id="confirmation-modal-title">Confirm Action</h3>
            <p id="confirmation-modal-prompt" style="color: var(--fg-gray); margin-bottom: 1rem;">Are you sure?</p>
            <div class="modal-actions">
                <button id="confirmation-modal-cancel-btn" class="btn btn-gray">Cancel</button>
                <button id="confirmation-modal-confirm-btn" class="btn btn-red">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal (REMOVED) -->

    <!-- Note Modal (Kept) -->
    <div id="note-modal-backdrop" class="modal-backdrop">
        <div id="note-modal-box" class="modal-box">
            <h3>Add/Edit Note</h3>
            
            <input type="hidden" id="modal-note-queue">
            <input type="hidden" id="modal-note-doc-id">
            <input type="hidden" id="modal-note-student-index">
            
            <label for="modal-note-input">Note:</label>
            <textarea id="modal-note-input" placeholder="Enter note..."></textarea>
            <p id="modal-note-error">Could not save note.</p>

            <div class="modal-actions">
                <button id="modal-note-cancel-btn" class="btn btn-gray">Cancel</button>
                <button id="modal-note-save-btn" class="btn btn-blue">Save Note</button>
            </div>
        </div>
    </div>
    
    <!-- Re-add Student Modal (Kept) -->
    <div id="re-add-modal-backdrop" class="modal-backdrop">
        <div id="re-add-modal-box" class="modal-box">
            <h3 id="re-add-modal-title">Re-add Student</h3>
            <p style="color: var(--fg-gray); margin-bottom: 1rem;">Re-add this student to which queue?</p>

            <input type="hidden" id="modal-re-add-doc-id">
            <input type="hidden" id="modal-re-add-name">
            <input type="hidden" id="modal-re-add-grade">
            <input type="hidden" id="modal-re-add-roster-id">
            
            <div class="btn-group" style="flex-direction: column;">
                <button id="modal-re-add-q1" class="btn btn-blue">Pre-K-5</button>
                <button id="modal-re-add-q2" class="btn btn-green">6th-8th</button>
                <button id="modal-re-add-q3" class="btn btn-gray">Walk</button>
            </div>

            <div class="modal-actions">
                <button id="modal-re-add-cancel-btn" class="btn btn-gray">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            getDocs,
            getDoc,
            updateDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyBbTFLhxzXf08OVDGGsK54t3qDzPVvsJ3w",
          authDomain: "conferencedoral.firebaseapp.com",
          databaseURL: "https://conferencedoral-default-rtdb.firebaseio.com",
          projectId: "conferencedoral",
          storageBucket: "conferencedoral.firebasestorage.app",
          messagingSenderId: "668062587354",
          appId: "1:668062587354:web:9b831842ada6ebf87148e3",
          measurementId: "G-HDJ9S9G2T2"
        };
        
        // --- DOM Elements ---
        const authStatus = document.getElementById('auth-status');
        
        // View Toggling
        const queuesTabBtn = document.getElementById('queues-tab-btn');
        const queuesView = document.getElementById('queues-view');

        // NEW: Classroom View
        const classroomTabBtn = document.getElementById('classroom-tab-btn');
        const classroomView = document.getElementById('classroom-view');
        const classroomListContainer = document.getElementById('classroom-list-container');
        const classroomTotalCount = document.getElementById('classroom-total-count');

        // Add Student Section
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const manualNameInput = document.getElementById('manual-name-input');
        const manualAddBtn = document.getElementById('manual-add-btn');
        const manualAddBtnSib = document.getElementById('manual-add-btn-sib');
        const manualAddBtnWalk = document.getElementById('manual-add-btn-walk');
        const stagedList = document.getElementById('sibling-group-list');
        const addStagedGroupBtn = document.getElementById('add-staged-group-btn');

        // Queues
        const q1TableBody = document.getElementById('q1-table-body');
        const q2TableBody = document.getElementById('q2-table-body');
        const q3TableBody = document.getElementById('q3-table-body');
        const q1Count = document.getElementById('q1-count');
        const q2Count = document.getElementById('q2-count');
        const q3Count = document.getElementById('q3-count');

        // Picked Up
        const pickedUpTableBody = document.getElementById('pickedup-table-body');
        const pickedUpCount = document.getElementById('pickedup-count');
        
        // Admin Panel (REMOVED)
        
        // Note Modal
        const noteModalBackdrop = document.getElementById('note-modal-backdrop');
        const modalNoteQueue = document.getElementById('modal-note-queue');
        const modalNoteDocId = document.getElementById('modal-note-doc-id');
        const modalNoteStudentIndex = document.getElementById('modal-note-student-index');
        const modalNoteInput = document.getElementById('modal-note-input');
        const modalNoteError = document.getElementById('modal-note-error');
        const modalNoteCancelBtn = document.getElementById('modal-note-cancel-btn');
        const modalNoteSaveBtn = document.getElementById('modal-note-save-btn');
        
        // Re-add Modal
        const reAddModalBackdrop = document.getElementById('re-add-modal-backdrop');
        const reAddModalTitle = document.getElementById('re-add-modal-title');
        const modalReAddDocId = document.getElementById('modal-re-add-doc-id');
        const modalReAddName = document.getElementById('modal-re-add-name');
        const modalReAddGrade = document.getElementById('modal-re-add-grade');
        const modalReAddRosterId = document.getElementById('modal-re-add-roster-id');
        const modalReAddQ1 = document.getElementById('modal-re-add-q1');
        const modalReAddQ2 = document.getElementById('modal-re-add-q2');
        const modalReAddQ3 = document.getElementById('modal-re-add-q3');
        const modalReAddCancelBtn = document.getElementById('modal-re-add-cancel-btn');

        // Confirmation Modal
        const confirmationModalBackdrop = document.getElementById('confirmation-modal-backdrop');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalPrompt = document.getElementById('confirmation-modal-prompt');
        const confirmationModalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        const confirmationModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');

        // Toast
        const toastContainer = document.getElementById('toast-container');
        
        // --- App State ---
        let confirmationModalAction = null;
        let stagedSiblingGroup = []; 
        // Roster and Groups are needed for search
        let currentRoster = []; 
        let currentPermanentGroups = [];
        let currentQ1 = [];
        let currentQ2 = [];
        let currentQ3 = [];
        let currentPickedUpList = [];
        
        // --- Firebase Globals ---
        let app, auth, db, userId;
        let q1ColRef, q2ColRef, q3ColRef, rosterColRef, pickedupColRef;
        let permanentGroupsColRef;
        const appId = firebaseConfig.projectId || 'default-carline-app';

        // --- Collection Names ---
        const Q1_COLLECTION = 'queue_k5';
        const Q2_COLLECTION = 'queue_siblings';
        const Q3_COLLECTION = 'queue_walkers';
        const PICKEDUP_COLLECTION = 'queue_pickedup';
        const ROSTER_COLLECTION = 'ROSTER';
        const PERMANENT_GROUPS_COLLECTION = 'permanent_groups';
        // Config collection removed

        // --- SVG Icons ---
        const icons = {
            star: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.846 5.673a1 1 0 00.95.69h5.969c.969 0 1.371 1.24.588 1.81l-4.83 3.51a1 1 0 00-.364 1.118l1.846 5.673c.3.921-.755 1.688-1.54 1.118l-4.83-3.51a1 1 0 00-1.175 0l-4.83 3.51c-.784.57-1.838-.197-1.54-1.118l1.846-5.673a1 1 0 00-.364-1.118L2.14 11.099c-.783-.57-.38-1.81.588-1.81h5.97a1 1 0 00.95-.69L11.049 2.927z"></path></svg>`,
            pencil: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
            trash: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`,
            remove: `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
            reAdd: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-4 4v6m0-6V7m0 0h.01M12 7h.01M12 7V3l-3 4m3-4l3 4"></path></svg>`
        };

        // --- Utility Functions ---
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        function sanitize(str) {
            if (typeof str !== 'string') return "";
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : 'success'}`;
            toast.textContent = sanitize(message);
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Render Functions ---

        function renderSearchResults(students, groups) {
            let html = '';

            if (groups.length > 0) {
                html += groups.map(group => `
                    <div class="search-item group-result">
                        <div>
                            <span style="font-weight: 500;">${sanitize(group.groupName)}</span>
                            <span style="color: var(--fg-gray); font-size: 0.8rem; margin-left: 4px;">(Permanent Group)</span>
                        </div>
                        <div class="search-item-actions">
                            <button class="btn btn-green" data-action="add-permanent-group" data-group-id="${group.id}">Add to Sibling Queue</button>
                        </div>
                    </div>
                `).join('');
            }

            if (students.length > 0) {
                html += students.map(student => {
                    const fullName = `${student.firstName} ${student.lastName}`;
                    return `
                    <div class="search-item">
                        <div>
                            <span style="font-weight: 500;">${fullName}</span>
                            <span style="color: var(--fg-gray); font-size: 0.8rem; margin-left: 4px;">(Gr: ${student.grade})</span>
                        </div>
                        <div class="search-item-actions">
                            <button class="btn btn-blue" data-queue="1" data-name="${fullName}" data-grade="${student.grade}" data-roster-id="${student.id}">K-5</button>
                            <button class="btn btn-green" data-queue="2" data-name="${fullName}" data-grade="${student.grade}" data-roster-id="${student.id}">6-8</button>
                            <button class="btn btn-gray" data-queue="3" data-name="${fullName}" data-grade="${student.grade}" data-roster-id="${student.id}">Walk</button>
                            <button class="btn btn-purple" data-action="stage-group" data-name="${fullName}" data-grade="${student.grade}" data-roster-id="${student.id}">Group</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            if (html === '') {
                searchResults.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students or groups found.</p>`;
                return;
            }
            searchResults.innerHTML = html;
        }

        function renderStagedGroup() {
            if (stagedSiblingGroup.length === 0) {
                stagedList.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">No students staged.</p>`;
                return;
            }
            stagedList.innerHTML = stagedSiblingGroup.map((student, index) => `
                <div class="sibling-item">
                    <span style="font-weight: 500;">${sanitize(student.name)} (Gr: ${sanitize(student.grade)})</span>
                    <button class="remove-staged-btn" data-index="${index}" title="Remove" style="background: none; border: none; color: var(--red); cursor: pointer;">
                        ${icons.remove}
                    </button>
                </div>
            `).join('');
        }
        
        function renderFlagIcons(flags) {
            if (!flags) return '';
            let iconsHtml = '';
            if (flags.allergy) {
                iconsHtml += `<span class="flag-icon" title="Allergy">⚠️</span>`;
            }
            if (flags.assistance) {
                iconsHtml += `<span class="flag-icon" title="Needs Assistance">♿</span>`;
            }
            return iconsHtml;
        }

        function renderQueueTable(tableBodyEl, countEl, queueName, docs) {
            if (queueName === Q1_COLLECTION) currentQ1 = docs;
            else if (queueName === Q3_COLLECTION) currentQ3 = docs;

            docs.sort((a, b) => (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0));
            countEl.textContent = `(${docs.length})`;
            
            if (docs.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--fg-gray);">Queue is empty.</td></tr>`;
                return;
            }
            
            tableBodyEl.innerHTML = docs.map(student => {
                const highlightClass = student.isHighlighted ? 'highlighted' : '';
                return `
                <tr class="${highlightClass}">
                    <td>${sanitize(student.name)} (${sanitize(student.grade)})${renderFlagIcons(student.flags)}</td>
                    <td>${sanitize(student.note)}</td>
                    <td class="actions-cell">
                        <button class="action-btn btn-highlight" title="Highlight"
                                data-action="highlight" data-id="${student.id}" data-queue="${queueName}">
                            ${icons.star}
                        </button>
                        <button class="action-btn btn-note" title="Note"
                                data-action="add-note" data-id="${student.id}" data-queue="${queueName}"
                                data-current-note="${sanitize(student.note)}">
                            ${icons.pencil}
                        </button>
                        <button class="action-btn btn-delete" title="Dismiss"
                                data-action="dismiss-queue" data-id="${student.id}" data-queue="${queueName}">
                            ${icons.trash}
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function renderSiblingTable(docs) {
            currentQ2 = docs; 
            docs.sort((a, b) => (a.addedAt?.seconds || 0) - (b.addedAt?.seconds || 0));
            
            let studentCount = docs.reduce((count, doc) => count + (doc.isGroup ? doc.students.length : 1), 0);
            q2Count.textContent = `(${studentCount})`;
            
            if (docs.length === 0) {
                q2TableBody.innerHTML = `<tr><td colspan="2" style="text-align: center; color: var(--fg-gray);">Queue is empty.</td></tr>`;
                return;
            }
            
            q2TableBody.innerHTML = docs.map(student => {
                let studentHtml = '';
                if (student.isGroup) {
                    studentHtml = '<strong style="color: var(--green);">GROUP:</strong><ul class="sibling-group-ul">' + 
                                  student.students.map((s, index) => {
                                      const highlightClass = s.isHighlighted ? 'highlighted' : '';
                                      const noteHtml = s.note ? ` <i style="color: var(--blue); font-size: 0.8rem;">(${sanitize(s.note)})</i>` : '';
                                      return `<li class="${highlightClass}">
                                          <span>${sanitize(s.name)} (${sanitize(s.grade)})${renderFlagIcons(s.flags)}${noteHtml}</span>
                                          <span class="actions-cell">
                                              <button class="action-btn btn-highlight" title="Highlight Student"
                                                      data-action="highlight-group-student" data-id="${student.id}" data-queue="${Q2_COLLECTION}" data-index="${index}">
                                                  ${icons.star}
                                              </button>
                                              <button class="action-btn btn-note" title="Note Student"
                                                      data-action="add-note-group" data-id="${student.id}" data-queue="${Q2_COLLECTION}" data-index="${index}"
                                                      data-current-note="${sanitize(s.note)}">
                                                  ${icons.pencil}
                                              </button>
                                              <button class="action-btn btn-delete" title="Dismiss Student"
                                                      data-action="dismiss-group-student" data-id="${student.id}" data-queue="${Q2_COLLECTION}" data-index="${index}">
                                                  ${icons.remove}
                                              </button>
                                          </span>
                                        </li>`;
                                    }
                                  ).join('') + '</ul>';
                } else {
                    const highlightClass = student.isHighlighted ? 'highlighted' : '';
                    const noteHtml = student.note ? ` <i style="color: var(--blue); font-size: 0.8rem;">(${sanitize(student.note)})</i>` : '';
                    studentHtml = `<span class="${highlightClass}">${sanitize(student.name)} (${sanitize(student.grade)})${renderFlagIcons(student.flags)}${noteHtml}</span>`;
                }
                
                return `
                <tr>
                    <td>${studentHtml}</td>
                    <td class="actions-cell">
                        ${!student.isGroup ? `
                        <button class="action-btn btn-highlight" title="Highlight"
                                data-action="highlight" data-id="${student.id}" data-queue="${Q2_COLLECTION}">
                            ${icons.star}
                        </button>
                        <button class="action-btn btn-note" title="Note"
                                data-action="add-note" data-id="${student.id}" data-queue="${Q2_COLLECTION}"
                                data-current-note="${sanitize(student.note)}">
                            ${icons.pencil}
                        </button>
                        ` : ''}
                        <button class="action-btn btn-delete" 
                                data-action="dismiss-queue" data-id="${student.id}" data-queue="${Q2_COLLECTION}"
                                title="Dismiss Entire Group/Student">
                            ${icons.trash}
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function calculateWaitTime(addedAt, pickedUpAt) {
            if (!addedAt || !pickedUpAt) return '--:--';
            try {
                const added = addedAt.toDate();
                const pickedUp = pickedUpAt.toDate();
                const diffMs = pickedUp.getTime() - added.getTime();
                if (diffMs < 0) return 'Error';

                const diffMins = Math.floor(diffMs / 60000);
                const diffSecs = Math.floor((diffMs % 60000) / 1000);
                
                return `${diffMins.toString().padStart(2, '0')}:${diffSecs.toString().padStart(2, '0')}`;
            } catch (e) {
                return '--:--';
            }
        }

        function renderPickedUpTable(docs) {
            currentPickedUpList = docs; 
            docs.sort((a, b) => (b.pickedUpAt?.seconds || 0) - (a.pickedUpAt?.seconds || 0));
            pickedUpCount.textContent = `(${docs.length})`;
            
            if (docs.length === 0) {
                pickedUpTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--fg-gray);">No students picked up.</td></tr>`;
                return;
            }
            
            pickedUpTableBody.innerHTML = docs.map(student => {
                return `
                <tr>
                    <td>${sanitize(student.name)}</td>
                    <td>${sanitize(student.grade)}</td>
                    <td>${formatTimestamp(student.pickedUpAt)}</td>
                    <td>${calculateWaitTime(student.addedAt, student.pickedUpAt)}</td>
                    <td class="actions-cell">
                        <button class="action-btn btn-re-add" title="Re-add to Queue"
                                data-action="re-add"
                                data-id="${student.id}"
                                data-name="${sanitize(student.name)}"
                                data-grade="${sanitize(student.grade)}"
                                data-roster-id="${student.rosterId || ''}">
                            ${icons.reAdd}
                        </button>
                        <button class="action-btn btn-delete" title="Remove Permanently"
                                data-action="remove-pickedup" 
                                data-id="${student.id}"
                                data-name="${sanitize(student.name)}">
                            ${icons.trash}
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }
        
        // NEW: renderClassroomView (copied from index.html)
        /**
         * Renders the classroom view (a single, dense list of all queued students).
         */
        function renderClassroomView() {
            let allStudents = [];

            // 1. Get Q1 students
            currentQ1.forEach(student => {
                allStudents.push({
                    name: student.name,
                    grade: student.grade,
                    isHighlighted: student.isHighlighted || false,
                    flags: student.flags || {} // Pass flags
                });
            });

            // 2. Get Q3 students
            currentQ3.forEach(student => {
                allStudents.push({
                    name: student.name,
                    grade: student.grade,
                    isHighlighted: student.isHighlighted || false,
                    flags: student.flags || {} // Pass flags
                });
            });

            // 3. Get Q2 students (flatten groups)
            currentQ2.forEach(doc => {
                if (doc.isGroup) {
                    doc.students.forEach(student => {
                        allStudents.push({
                            name: student.name,
                            grade: student.grade,
                            isHighlighted: student.isHighlighted || false,
                            flags: student.flags || {} // Pass flags
                        });
                    });
                } else {
                    // Single student in Q2
                    allStudents.push({
                        name: doc.name,
                        grade: doc.grade,
                        isHighlighted: doc.isHighlighted || false,
                        flags: doc.flags || {} // Pass flags
                    });
                }
            });

            // 4. Update total count
            classroomTotalCount.textContent = `(${allStudents.length})`;

            // 5. Sort alphabetically
            allStudents.sort((a, b) => a.name.localeCompare(b.name));

            // 6. Render HTML
            if (allStudents.length === 0) {
                classroomListContainer.innerHTML = `<p style="text-align: center; color: var(--fg-gray); font-size: 1.2rem; padding: 2rem 0;">No students in queue.</p>`;
                return;
            }

            classroomListContainer.innerHTML = allStudents.map(student => {
                const highlightClass = student.isHighlighted ? 'highlighted' : '';
                return `
                <div class="classroom-list-item ${highlightClass}">
                    ${sanitize(student.name)}
                    <span class="grade">(${sanitize(student.grade)})</span>
                    ${renderFlagIcons(student.flags)}
                </div>
                `;
            }).join('');
        }


        // Admin render functions REMOVED

        // --- Firebase Actions ---

        async function addStudentToQueue(queueNum, name, grade, rosterId = null) {
            let collection;
            if (queueNum == 1) collection = q1ColRef;
            else if (queueNum == 2) collection = q2ColRef;
            else if (queueNum == 3) collection = q3ColRef;
            else return;

            let flags = {};
            if (rosterId) {
                const student = currentRoster.find(s => s.id === rosterId);
                if (student && student.flags) {
                    flags = student.flags;
                }
            }

            try {
                await addDoc(collection, {
                    name: name,
                    grade: grade,
                    rosterId: rosterId || null,
                    flags: flags, 
                    addedAt: serverTimestamp(),
                    addedBy: userId,
                    isHighlighted: false,
                    note: ""
                });
                showToast(`${name} added to queue.`, false);
            } catch (error) {
                console.error("Error adding student: ", error);
                showToast(`Error adding ${name}: ${error.message}`, true);
            }
        }

        async function addGroupToQueue(studentGroup) {
            if (studentGroup.length === 0) return;

            const studentsForFirestore = studentGroup.map(student => {
                let flags = {};
                if (student.rosterId) {
                    const rosterStudent = currentRoster.find(s => s.id === student.rosterId);
                    if (rosterStudent && rosterStudent.flags) {
                        flags = rosterStudent.flags;
                    }
                }
                return {
                    name: student.name,
                    grade: student.grade,
                    rosterId: student.rosterId || null,
                    flags: flags,
                    isHighlighted: false,
                    note: ""
                };
            });

            try {
                await addDoc(q2ColRef, {
                    isGroup: true,
                    students: studentsForFirestore,
                    addedAt: serverTimestamp(),
                    addedBy: userId
                });
                
                stagedSiblingGroup = [];
                renderStagedGroup();
                showToast(`Group added to queue.`, false);
            } catch (error) {
                console.error("Error adding group to queue: ", error);
                showToast(`Error adding group: ${error.message}`, true);
            }
        }

        async function addPermanentGroupToQueue(groupId) {
            const group = currentPermanentGroups.find(g => g.id === groupId);
            if (!group) return;

            const studentGroup = group.students.map(studentId => {
                const student = currentRoster.find(s => s.id === studentId);
                if (!student) return null;
                return {
                    name: `${student.firstName} ${student.lastName}`,
                    grade: student.grade,
                    rosterId: student.id,
                    flags: student.flags || {} 
                };
            }).filter(s => s !== null);

            if (studentGroup.length > 0) {
                 try {
                    await addDoc(q2ColRef, {
                        isGroup: true,
                        students: studentGroup.map(s => ({ ...s, isHighlighted: false, note: "" })),
                        addedAt: serverTimestamp(),
                        addedBy: userId
                    });
                    showToast(`${group.groupName} added to queue.`, false);
                } catch(error) {
                    console.error("Error adding permanent group to queue: ", error);
                    showToast(`Error adding group: ${error.message}`, true);
                }
            }
        }

        async function dismissStudent(queueName, docId) {
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
                const studentDoc = await getDoc(docRef);
                
                if (studentDoc.exists()) {
                    const studentData = studentDoc.data();
                    
                    if (studentData.isGroup) {
                        const addPromises = studentData.students.map(student => {
                            return addDoc(pickedupColRef, {
                                name: student.name,
                                grade: student.grade,
                                rosterId: student.rosterId || null,
                                addedAt: studentData.addedAt || null, 
                                pickedUpAt: serverTimestamp(),
                                addedBy: userId
                            });
                        });
                        await Promise.all(addPromises);
                    } else {
                        await addDoc(pickedupColRef, {
                            name: studentData.name,
                            grade: studentData.grade,
                            rosterId: studentData.rosterId || null,
                            addedAt: studentData.addedAt || null, 
                            pickedUpAt: serverTimestamp(),
                            addedBy: userId
                        });
                    }
                    await deleteDoc(docRef);
                    showToast(`Dismissed entry.`, false);
                }
            } catch (error) {
                console.error("Error dismissing student: ", error);
                showToast(`Error dismissing: ${error.message}`, true);
            }
        }

        async function dismissGroupStudent(queueName, docId, studentIndex) {
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
                const studentDoc = await getDoc(docRef);

                if (!studentDoc.exists()) return;
                
                const groupData = studentDoc.data();
                let students = groupData.students;
                const studentToDismiss = students[studentIndex];

                if (!studentToDismiss) return;

                await addDoc(pickedupColRef, {
                    name: studentToDismiss.name,
                    grade: studentToDismiss.grade,
                    rosterId: studentToDismiss.rosterId || null,
                    addedAt: groupData.addedAt || null, 
                    pickedUpAt: serverTimestamp(),
                    addedBy: userId
                });

                students.splice(studentIndex, 1);

                if (students.length === 0) {
                    await deleteDoc(docRef);
                } else {
                    await updateDoc(docRef, { students: students });
                }
                showToast(`Dismissed ${studentToDismiss.name}.`, false);
            } catch (error) {
                console.error("Error dismissing group student: ", error);
                showToast(`Error dismissing student: ${error.message}`, true);
            }
        }

        // Admin clear functions REMOVED

        async function removePickedUpStudent(docId) {
            try {
                const docRef = doc(db, pickedupColRef.path, docId);
                await deleteDoc(docRef);
                showToast(`Removed student from "Picked Up".`, false);
            } catch (error) {
                console.error("Error removing picked up student: ", error);
                showToast(`Error removing student: ${error.message}`, true);
            }
        }
        
        async function toggleHighlight(queueName, docId) {
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
                const studentDoc = await getDoc(docRef);
                if (studentDoc.exists()) {
                    const currentHighlight = studentDoc.data().isHighlighted || false;
                    await updateDoc(docRef, { isHighlighted: !currentHighlight });
                }
            } catch (error) {
                console.error("Error toggling highlight: ", error);
                showToast(`Highlight error: ${error.message}`, true);
            }
        }

        async function toggleGroupStudentHighlight(queueName, docId, studentIndex) {
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${queueName}/${docId}`);
                const studentDoc = await getDoc(docRef);

                if (studentDoc.exists()) {
                    const studentData = studentDoc.data();
                    const students = studentData.students;
                    if (students && students[studentIndex]) {
                        students[studentIndex].isHighlighted = !students[studentIndex].isHighlighted;
                    }
                    await updateDoc(docRef, { students: students });
                }
            } catch (error) {
                console.error("Error toggling group student highlight: ", error);
                showToast(`Highlight error: ${error.message}`, true);
            }
        }
        
        function openNoteModal(queue, docId, studentIndex, currentNote) {
            modalNoteQueue.value = queue;
            modalNoteDocId.value = docId;
            modalNoteStudentIndex.value = (studentIndex === null || studentIndex === undefined) ? '' : studentIndex;
            modalNoteInput.value = currentNote;
            modalNoteError.style.display = 'none';
            noteModalBackdrop.style.display = 'flex';
            modalNoteInput.focus();
        }
        function closeNoteModal() {
            noteModalBackdrop.style.display = 'none';
        }
        async function handleNoteSave() {
            const queue = modalNoteQueue.value;
            const docId = modalNoteDocId.value;
            const studentIndex = modalNoteStudentIndex.value ? parseInt(modalNoteStudentIndex.value, 10) : null;
            const newNote = modalNoteInput.value.trim();

            if (!queue || !docId) {
                modalNoteError.style.display = 'block';
                return;
            }

            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${queue}/${docId}`);
                
                if (studentIndex === null) {
                    await updateDoc(docRef, { note: newNote });
                } else {
                    const studentDoc = await getDoc(docRef);
                    if (studentDoc.exists()) {
                        const students = studentDoc.data().students;
                        if (students && students[studentIndex] !== undefined) {
                            students[studentIndex].note = newNote;
                        }
                        await updateDoc(docRef, { students: students });
                    }
                }
                closeNoteModal();
                showToast(`Note saved.`, false);
            } catch (error) {
                console.error("Error updating note: ", error);
                modalNoteError.textContent = `Error: ${error.message}`;
                modalNoteError.style.display = 'block';
            }
        }

        // Admin roster/group functions REMOVED

        // --- Modal Functions ---
        
        // Password Modal functions REMOVED
        
        // Edit Student Modal functions REMOVED

        function openReAddModal(docId, name, grade, rosterId) {
            modalReAddDocId.value = docId;
            modalReAddName.value = name;
            modalReAddGrade.value = grade;
            modalReAddRosterId.value = rosterId;
            reAddModalTitle.textContent = `Re-add ${sanitize(name)}`;
            reAddModalBackdrop.style.display = 'flex';
        }
        function closeReAddModal() {
            reAddModalBackdrop.style.display = 'none';
        }
        async function handleReAdd(queueNum) {
            const docId = modalReAddDocId.value;
            const name = modalReAddName.value;
            const grade = modalReAddGrade.value;
            const rosterId = modalReAddRosterId.value;

            await addStudentToQueue(queueNum, name, grade, rosterId);
            await removePickedUpStudent(docId);
            
            closeReAddModal();
        }


        function openConfirmationModal(title, prompt, actionPayload) {
            confirmationModalTitle.textContent = title;
            confirmationModalPrompt.textContent = prompt;
            confirmationModalAction = actionPayload;
            confirmationModalBackdrop.style.display = 'flex';
        }
        function closeConfirmationModal() {
            confirmationModalBackdrop.style.display = 'none';
            confirmationModalAction = null;
        }

        // SIMPLIFIED: No password check
        async function handleConfirmationConfirm() {
            if (!confirmationModalAction) return;

            const { action, docId, queue, studentIndex } = confirmationModalAction;
            
            if (action === 'removePickedUp') {
                await removePickedUpStudent(docId);
            } else if (action === 'dismissGroupStudent') {
                await dismissGroupStudent(queue, docId, studentIndex);
            } else if (action === 'dismissQueue') {
                await dismissStudent(queue, docId);
            }
            
            closeConfirmationModal();
        }
        
        // handlePasswordConfirm REMOVED

        // --- Firebase Setup ---
        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); 

                authStatus.textContent = "Authenticating...";
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = "Connected";
                        authStatus.classList.add('connected');
                        setupListeners();
                    } else {
                        authStatus.textContent = "Connection Failed. Not Authenticated.";
                        authStatus.classList.add('disconnected');
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error: ", error);
                authStatus.textContent = "Connection Failed. Check console.";
                authStatus.classList.add('disconnected');
            }
        }
        
        function setupListeners() {
            if (!db) return; 

            q1ColRef = collection(db, `/artifacts/${appId}/public/data/${Q1_COLLECTION}`);
            q2ColRef = collection(db, `/artifacts/${appId}/public/data/${Q2_COLLECTION}`);
            q3ColRef = collection(db, `/artifacts/${appId}/public/data/${Q3_COLLECTION}`);
            pickedupColRef = collection(db, `/artifacts/${appId}/public/data/${PICKEDUP_COLLECTION}`);
            // Roster and Groups are still needed for search
            rosterColRef = collection(db, `/artifacts/${appId}/public/data/${ROSTER_COLLECTION}`);
            permanentGroupsColRef = collection(db, `/artifacts/${appId}/public/data/${PERMANENT_GROUPS_COLLECTION}`);
            // Broadcast listener REMOVED

            // Listeners
            onSnapshot(query(q1ColRef), (snapshot) => {
                currentQ1 = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQueueTable(q1TableBody, q1Count, Q1_COLLECTION, currentQ1);
                if (classroomView.style.display !== 'none') renderClassroomView(); // NEW
            }, (error) => console.error("Q1 Snapshot Error:", error));

            onSnapshot(query(q2ColRef), (snapshot) => {
                currentQ2 = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSiblingTable(currentQ2);
                if (classroomView.style.display !== 'none') renderClassroomView(); // NEW
            }, (error) => console.error("Q2 Snapshot Error:", error));

            onSnapshot(query(q3ColRef), (snapshot) => {
                currentQ3 = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQueueTable(q3TableBody, q3Count, Q3_COLLECTION, currentQ3); 
                if (classroomView.style.display !== 'none') renderClassroomView(); // NEW
            }, (error) => console.error("Q3 Snapshot Error:", error));
            
            onSnapshot(query(pickedupColRef), (snapshot) => {
                currentPickedUpList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPickedUpTable(currentPickedUpList);
            }, (error) => console.error("PickedUp Snapshot Error:", error));

            // Roster listener (needed for search)
            onSnapshot(query(rosterColRef), (snapshot) => {
                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                students.sort((a, b) => {
                    const lastCompare = (a.lastName || '').localeCompare(b.lastName || '');
                    if (lastCompare !== 0) return lastCompare;
                    return (a.firstName || '').localeCompare(b.firstName || '');
                });
                
                currentRoster = students; 
                
                if (searchInput.value.trim().length > 0) {
                    filterStudents(searchInput.value.trim());
                }
            }, (error) => console.error("Roster Snapshot Error:", error));
            
            // Permanent Groups listener (needed for search)
            onSnapshot(query(permanentGroupsColRef), (snapshot) => {
                currentPermanentGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentPermanentGroups.sort((a, b) => a.groupName.localeCompare(b.groupName));
            }, (error) => console.error("Permanent Groups Snapshot Error:", error));

            // Broadcast listener REMOVED
        }

        function filterStudents(searchText) {
            const lowerCaseSearch = searchText.toLowerCase();
            if (searchText.length === 0) {
                searchResults.innerHTML = `<p style="padding: 0.5rem 0.75rem; color: var(--fg-gray);">Start typing to see results...</p>`;
                return;
            }
            const filteredStudents = currentRoster.filter(student => 
                `${student.firstName} ${student.lastName}`.toLowerCase().includes(lowerCaseSearch)
            );
            const filteredGroups = currentPermanentGroups.filter(group => 
                group.groupName.toLowerCase().includes(lowerCaseSearch)
            );
            renderSearchResults(filteredStudents, filteredGroups);
        }

        // filterAdminGroupSearch REMOVED
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {

            setupFirebase();
            
            // Phone mode listeners REMOVED (it's hardcoded)
            
            // NEW: Tab Toggling Listeners
            queuesTabBtn.addEventListener('click', () => {
                queuesView.style.display = 'block';
                classroomView.style.display = 'none';
                queuesTabBtn.classList.add('active');
                classroomTabBtn.classList.remove('active');
            });

            classroomTabBtn.addEventListener('click', () => {
                queuesView.style.display = 'none';
                classroomView.style.display = 'block';
                queuesTabBtn.classList.remove('active');
                classroomTabBtn.classList.add('active');
                // Render the view when tab is clicked
                renderClassroomView(); 
            });

            // --- Add Student Section Listeners ---
            searchInput.addEventListener('input', (e) => filterStudents(e.target.value));

            searchResults.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const { queue, name, grade, action, groupId, rosterId } = target.dataset;

                if (action === 'stage-group') {
                    stagedSiblingGroup.push({ name, grade, rosterId }); 
                    renderStagedGroup();
                } else if (action === 'add-permanent-group') {
                    addPermanentGroupToQueue(groupId);
                    searchInput.value = '';
                    filterStudents('');
                } else if (name && grade && queue) {
                    addStudentToQueue(queue, name, grade, rosterId); 
                    searchInput.value = '';
                    filterStudents('');
                }
            });

            stagedList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-staged-btn');
                if (removeBtn) {
                    stagedSiblingGroup.splice(parseInt(removeBtn.dataset.index, 10), 1);
                    renderStagedGroup();
                }
            });
            
            addStagedGroupBtn.addEventListener('click', () => addGroupToQueue(stagedSiblingGroup));
            manualAddBtn.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(1, name, 'N/A'); manualNameInput.value = ''; }
            });
            manualAddBtnSib.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(2, name, 'N/A'); manualNameInput.value = ''; }
            });
            manualAddBtnWalk.addEventListener('click', () => {
                const name = manualNameInput.value.trim();
                if (name) { addStudentToQueue(3, name, 'N/A'); manualNameInput.value = ''; }
            });
            
            // Admin Panel Listeners REMOVED

            // --- Delegated clicks for all TABLE actions ---
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('.action-btn');
                if (!target) return;

                const { action, id, name, queue, currentNote, grade, rosterId } = target.dataset;
                const studentIndex = target.dataset.index ? parseInt(target.dataset.index, 10) : null;
                
                if (action === 'dismiss-queue') {
                    openConfirmationModal(
                        'Dismiss Student/Group?',
                        `Are you sure you want to dismiss this entry?`,
                        { action: 'dismissQueue', docId: id, queue: queue }
                    );
                } else if (action === 'remove-pickedup') {
                    openConfirmationModal(
                        'Remove from Picked Up?',
                        `Are you sure you want to remove ${name}?`,
                        { action: 'removePickedUp', docId: id }
                    );
                } else if (action === 'dismiss-group-student') {
                    openConfirmationModal(
                        'Dismiss Student?',
                        `Are you sure you want to dismiss this student from the group?`,
                        { action: 'dismissGroupStudent', docId: id, queue: queue, studentIndex: studentIndex }
                    );
                } else if (action === 'highlight') {
                    toggleHighlight(queue, id);
                } else if (action === 'highlight-group-student') {
                    toggleGroupStudentHighlight(queue, id, studentIndex);
                } else if (action === 'add-note' || action === 'add-note-group') {
                    openNoteModal(queue, id, studentIndex, currentNote);
                } else if (action === 're-add') {
                    openReAddModal(id, name, grade, rosterId);
                }
            });
            
            // --- Modal Listeners ---
            // Password modal listeners REMOVED
            confirmationModalCancelBtn.addEventListener('click', closeConfirmationModal);
            confirmationModalConfirmBtn.addEventListener('click', handleConfirmationConfirm);
            
            // Edit Student modal listeners REMOVED

            // Note Modal Listeners
            modalNoteCancelBtn.addEventListener('click', closeNoteModal);
            modalNoteSaveBtn.addEventListener('click', handleNoteSave);
            
            // Re-add Modal Listeners
            modalReAddCancelBtn.addEventListener('click', closeReAddModal);
            modalReAddQ1.addEventListener('click', () => handleReAdd(1));
            modalReAddQ2.addEventListener('click', () => handleReAdd(2));
            modalReAddQ3.addEventListener('click', () => handleReAdd(3));
        });
    </script>

</body>
</html>
